<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><title>Cluster Api - multi-tenancy EKS implementation | Luca Lanziani</title><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#ff3db4><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary"><meta name=twitter:site content="lanziani.com"><meta name=twitter:title content="Multi-tenancy EKS with Cluster Api"><meta name=twitter:image content><link rel=stylesheet href=https://lanziani.com/css/main.min.c2f324a162cf1ee16a45306297cd634cea8c60ba7804af176658cd335e205d4f.css><link rel=stylesheet href=https://lanziani.com/css/custom.min.6bc15e3c69d81b1f2b161dc36a93e5eae638cc22df0f8eeb410ffd686d09ff87.css></head><body><nav><header><div class=site-title><a href=/>Luca Lanziani</a></div></header><div class=nav-menu><a class="color-link nav-link" href=/>Home</a>
<a class="color-link nav-link" href=/about/>About</a>
<a class="color-link nav-link" href=/tags/>Tags</a>
<a class="color-link nav-link" href=/archives/>Archives</a>
<a class="color-link nav-link" href=https://lanziani.com/index.xml target=_blank rel=noopener type=application/rss+xml>RSS</a></div><footer class=footer><div class=social-icons><a class=social-icon href=mailto:luca+site@lanziani.com target=_blank rel=noopener title=Email><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M25.2794292 5.59128519 14 16.8707144 2.72057081 5.59128519C3.06733103 5.30237414 3.51336915 5.12857603 4 5.12857603H24c.4866308.0.932669000000001.173798110000001 1.2794292.46270916zM25.9956978 6.99633695C25.998551 7.04004843 26 7.08414302 26 7.12857603V20.871424C26 21.0798433 25.9681197 21.2808166 25.9089697 21.4697335l-7.1933342-7.1933342 7.2800623-7.28006235zM24.9498374 22.6319215C24.6672737 22.7846939 24.3437653 22.871424 24 22.871424H4C3.5268522 22.871424 3.09207889 22.7071233 2.74962118 22.432463l7.34540352-7.3454036 3.8897821 3.8897821L14.1878486 18.7737996l.0151933.0151933 3.4519334-3.4519335 7.2948621 7.2948621zM2.00810114 21.0526627C2.00273908 20.9929669 2 20.9325153 2 20.871424V7.12857603C2 7.08414302 2.00144896 7.04004843 2.00430222 6.99633695L9.03436454 14.0263993l-7.0262634 7.0262634z"/></svg></a><a class=social-icon href=https://twitter.com/lucalanziani target=_blank rel=noopener title=Twitter><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M8.991284 24.971612c10.189152.0 15.761088-8.441388 15.761088-15.761088C24.752372 8.970656 24.747512 8.731868 24.736496 8.494376 25.818008 7.712564 26.758256 6.737 27.5 5.62622c-.992628.440856-2.060748.738072-3.181248.871992 1.14372-.685584 2.02176-1.770768 2.435832-3.064176-1.070496.6345-2.25558 1.095984-3.517344 1.344492-1.010772-1.076652-2.450412-1.75014-4.043412-1.75014-3.059424.0-5.540292 2.480868-5.540292 5.539104.0.434808.0487079999999995.857412.14364 1.26306C9.19346 9.599108 5.11106 7.39472 2.3792 4.04294c-.476172.818424-.750168 1.769688-.750168 2.784132.0 1.921968.97794 3.61854 2.464992 4.61106C3.185528 11.41016 2.331788 11.160464 1.585184 10.745096 1.583888 10.768208 1.583888 10.791428 1.583888 10.815728c0 2.683152 1.909764 4.922856 4.4442 5.43078C5.562932 16.373084 5.07326 16.44134 4.56782 16.44134 4.210988 16.44134 3.863876 16.406024 3.526484 16.34144c.70524 2.200824 2.750112 3.802356 5.174928 3.8475-1.896264 1.485756-4.284576 2.37114-6.879924 2.37114C1.374476 22.56008.93362 22.534592.5 22.4834c2.451708 1.571076 5.362524 2.488212 8.491284 2.488212"/></svg></a><a class=social-icon href=https://www.linkedin.com/in/lucalanziani/ target=_blank rel=noopener title=LinkedIn><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M2 3.654102c0-.95502059.79442509-1.73012354 1.77383592-1.73012354H24.2261641C25.2058917 1.92397846 26 2.69908141 26 3.654102V24.3462148C26 25.3015521 25.2058917 26.0760215 24.2261641 26.0760215H3.77383592C2.79442509 26.0760215 2 25.3015521 2 24.3465315V3.65378524 3.654102zM9.27526132 22.1415901V11.2356668H5.65030092V22.1415901H9.27557808 9.27526132zM7.46341463 9.74691162c1.2638581.0 2.05068103-.83750395 2.05068103-1.88406715C9.49033893 6.79252455 8.72727273 5.97846056 7.48748812 5.97846056c-1.24073487.0-2.05099778.81406399-2.05099778 1.88438391.0 1.0465632.78650618 1.88406715 2.00316756 1.88406715h.02343998H7.46341463zM11.2815965 22.1415901h3.6246436v-6.089642C14.9062401 15.7263225 14.9299968 15.4000634 15.0256573 15.1675641c.261957499999999-.6515679.8584099-1.3259423 1.8599936-1.3259423 1.3113716.0 1.836237 1 1.836237 2.4662654v5.8337029h3.6246436V15.8885017c0-3.349699-1.7880899-4.9084574-4.172949-4.9084574-1.9553373.0-2.814064 1.0928097-3.2910991 1.8371872H14.9065569v-1.581248H11.2819132C11.3291099 12.2591067 11.2815965 22.1419069 11.2815965 22.1419069V22.1415901z"/></svg></a><a class=social-icon href=https://github.com/LucaLanziani target=_blank rel=noopener title=GitHub><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M13.9988029 1.32087331C6.82105037 1.32087331 1 7.14112562 1 14.3212723c0 5.7436386 3.72454649 10.6157955 8.89038951 12.3348169C10.5408085 26.7757983 10.7778323 26.374374 10.7778323 26.0296121 10.7778323 25.7215609 10.7666595 24.9035493 10.760275 23.8189856 7.14426471 24.6042767 6.38131925 22.0760223 6.38131925 22.0760223c-.59136253-1.5019491-1.44369072-1.9017772-1.44369072-1.9017772C3.75729765 19.3682044 5.02701126 19.3841656 5.02701126 19.3841656 6.33183953 19.4759425 7.01817121 20.7241085 7.01817121 20.7241085c1.15958133 1.9863716 3.04300319 1.4125664 3.78360289 1.0797753.1181129-.8395592.4540962-1.4125663.8251942-1.7373768C8.74038491 19.7385043 5.70536235 18.6228163 5.70536235 13.6413251c0-1.4189508.50676816-2.5801283 1.33834679-3.4883207C6.90963504 9.82420367 6.46351945 8.50181809 7.17139875 6.71256734c0 0 1.09094816-.34955032 3.57451115 1.33276037C11.78259 7.75642995 12.8950858 7.61277914 14.000399 7.60719272 15.1049142 7.61277914 16.2166119 7.75642995 17.2548881 8.04532771c2.4819669-1.68231069 3.571319-1.33276037 3.571319-1.33276037C21.5356825 8.50181809 21.0895669 9.82420367 20.9562909 10.1530044 21.7894656 11.0611968 22.2922435 12.2223743 22.2922435 13.6413251c0 4.9942601-3.039811 6.0931889-5.935173 6.4148071.4660671.401424200000001.8818564 1.194696.8818564 2.4077473C17.2389269 24.2012564 17.2229657 25.603448 17.2229657 26.0296121 17.2229657 26.3775663 17.4575954 26.7821827 18.116793 26.6552912 23.2786458 24.9322794 27 20.0633148 27 14.3212723 27 7.14112562 21.1789496 1.32087331 13.9988029 1.32087331"/></svg></a></div><p><a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy theme</a></p><p><a href=https://gohugo.io target=_blank rel=noopener>Built with Hugo</a></p><script src=https://lanziani.com/js/main.min.a7205ef73b078c8daed6fe1b0826e8ba229ffabbb69d299d9446cf41f2c7d8aa.js integrity="sha256-pyBe9zsHjI2u1v4bCCbouiKf+ru2nSmdlEbPQfLH2Ko=" crossorigin=anonymous></script></footer></nav><div id=main-content><div id=content class=content-container><time>March 12, 2022</time><h1 class=post-title>Cluster Api - multi-tenancy EKS implementation</h1><div class=post><p><p><a href=https://cluster-api.sigs.k8s.io>Cluster API</a> in case you don&rsquo;t know it is:</p><blockquote><p>a Kubernetes sub-project focused on providing declarative APIs and tooling to simplify provisioning, upgrading, and operating multiple Kubernetes clusters.</p></blockquote><p>Multi-tenancy is defined by the project itself:</p><blockquote><p>Starting from v0.6.5, single controller multi-tenancy is supported that allows using a different AWS Identity for each workload cluster. For details, see the <a href=https://github.com/kubernetes-sigs/cluster-api-provider-aws/blob/main/docs/proposal/20200506-single-controller-multitenancy.md>multi-tenancy proposal</a>.</p></blockquote><p>That is exactly what we are going to see in this post.</p><p>Cluster API supports multiple Providers, and the one we want to focus on today is the <a href=https://cluster-api-aws.sigs.k8s.io/>Provider AWS</a>.</p><p>Specifically, we want to use it to provision EKS clusters with managed nodes.</p><h2 id=prerequisites>Prerequisites</h2><ul><li>A bootstrap cluster</li><li>AWS cli installed</li><li>2 AWS accounts with relative credentials<ul><li>manager account</li><li>managed account</li></ul></li><li><a href=https://github.com/kubernetes-sigs/cluster-api-provider-aws/releases>clusterawsadm</a><ul><li><a href=https://cluster-api-aws.sigs.k8s.io/topics/eks/prerequisites.html>https://cluster-api-aws.sigs.k8s.io/topics/eks/prerequisites.html</a></li></ul></li><li><a href=https://github.com/kubernetes-sigs/cluster-api/releases>clusterctl</a></li></ul><h3 id=set-variables>Set variables</h3><p>We want to export some environment variables</p><ul><li>AWS_REGION</li><li>AWS_ACCESS_KEY_ID</li><li>AWS_SECRET_ACCESS_KEY</li><li>AWS_SESSION_TOKEN (if you are using Multi-factor authentication)</li><li>AWS_MANAGER_ACCOUNT_ID</li><li>AWS_MANAGED_ACCOUNT_ID</li><li>OIDC_PROVIDER_ID=&ldquo;weresetthislater&rdquo;</li></ul><h3 id=prepare-the-manager-account>Prepare the manager account</h3><p>As Cluster API EKS prerequisites <a href=https://cluster-api-aws.sigs.k8s.io/topics/eks/prerequisites.html>page</a> explains, we need a couple of roles in the account to build the cluster and this can be done with <code>clusterawsadm</code> cli.</p><p>In order to allow for cross account assume role we are going to change the clusterawsadm configuration to add an extra inline policy to the <code>controllers.cluster-api-provider-aws.sigs.k8s.io</code> role.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>envsubst &gt; bootstrap-manager-account.yaml <span style=color:#e6db74>&lt;&lt; EOL
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: bootstrap.aws.infrastructure.cluster.x-k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: AWSIAMConfiguration
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  eks:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    iamRoleCreation: false # Set to true if you plan to use the EKSEnableIAM feature flag to enable automatic creation of IAM roles
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    managedMachinePool:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      disable: true # Set to false to enable creation of the default node role for managed machine pools
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    fargate:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      disable: false # Set to false to enable creation of the default role for the fargate profiles
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  clusterAPIControllers:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    disabled: false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    extraStatements:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Action:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - &#34;sts:AssumeRole&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      Effect: &#34;Allow&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      Resource: [&#34;arn:aws:iam::${AWS_MANAGED_ACCOUNT_ID}:role/controllers.cluster-api-provider-aws.sigs.k8s.io&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    trustStatements:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Action:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - &#34;sts:AssumeRoleWithWebIdentity&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      Effect: &#34;Allow&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      Principal:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Federated:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - &#34;arn:aws:iam::${AWS_MANAGER_ACCOUNT_ID}:oidc-provider/oidc.eks.${AWS_REGION}.amazonaws.com/id/${OIDC_PROVIDER_ID}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      Condition:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;ForAnyValue:StringEquals&#34;:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &#34;oidc.eks.${AWS_REGION}.amazonaws.com/id/${OIDC_PROVIDER_ID}:sub&#34;:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            - system:serviceaccount:capa-system:capa-controller-manager
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            - system:serviceaccount:capa-eks-control-plane-system:capa-eks-control-plane-controller-manager # Include if also using EKS
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOL</span>
</span></span></code></pre></div><p>We can then use the above configuration to bootstrap the Manager cluster</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>clusterawsadm bootstrap iam create-cloudformation-stack --config bootstrap-manager-account.yaml
</span></span></code></pre></div><h3 id=install-cluster-api-provider-in-the-bootstrap-cluster>Install cluster API provider in the bootstrap cluster</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export AWS_B64ENCODED_CREDENTIALS<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>clusterawsadm bootstrap credentials encode-as-profile<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>export EKS<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>export EXP_MACHINE_POOL<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>clusterctl init --infrastructure aws --target-namespace capi-providers
</span></span></code></pre></div><h3 id=generate-the-manager-cluster>Generate the manager cluster</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export AWS_SSH_KEY_NAME<span style=color:#f92672>=</span>default
</span></span><span style=display:flex><span>export VPC_ADDON_VERSION<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;v1.10.2-eksbuild.1&#34;</span>
</span></span><span style=display:flex><span>clusterctl generate cluster manager --flavor eks-managedmachinepool-vpccni --kubernetes-version v1.20.2 --worker-machine-count<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> &gt; manager-cluster.yaml
</span></span></code></pre></div><p>Apply the cluster to the bootstrap cluster</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f manager-cluster.yaml
</span></span></code></pre></div><h3 id=create-an-iam-oidc-identity-provider-for-your-cluster-with-the-aws-management-console>Create an IAM OIDC identity provider for your cluster with the AWS Management Console</h3><p>You can follow the instruction on this page to create an OIDC provider <a href=https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html>https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html</a></p><h3 id=update-the-iam-role-to-use-this-oidc-id>Update the IAM role to use this OIDC ID</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export OIDC_PROVIDER_ID<span style=color:#f92672>=</span>&lt;OIDC_ID_OF_THE_CLUSTER&gt;
</span></span></code></pre></div><p>run the <code>Prepare the manager account</code> step again.</p><p>This will update the <code>controllers.cluster-api-provider-aws.sigs.k8s.io</code> role.</p><h3 id=get-the-manager-cluster-credentials>Get the manager cluster credentials</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl --namespace<span style=color:#f92672>=</span>default get secret manager-user-kubeconfig <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   -o jsonpath<span style=color:#f92672>={</span>.data.value<span style=color:#f92672>}</span> | base64 --decode <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   &gt; manager.kubeconfig
</span></span></code></pre></div><h3 id=install-the-cluster-api-provider-in-the-manager-cluster>Install the Cluster API provider in the manager cluster</h3><p>This will install the Cluster API providers into the manager cluster and create a service account to use the <code>controllers.cluster-api-provider-aws.sigs.k8s.io</code> role for the Management Components.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export AWS_B64ENCODED_CREDENTIALS<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>clusterawsadm bootstrap credentials encode-as-profile<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>export EKS<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>export EXP_MACHINE_POOL<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>export AWS_CONTROLLER_IAM_ROLE<span style=color:#f92672>=</span>arn:aws:iam::<span style=color:#e6db74>${</span>AWS_MANAGER_ACCOUNT_ID<span style=color:#e6db74>}</span>:role/controllers.cluster-api-provider-aws.sigs.k8s.io
</span></span><span style=display:flex><span>clusterctl init --kubeconfig manager.kubeconfig --infrastructure aws --target-namespace capi-providers
</span></span></code></pre></div><h3 id=generate-the-managed-cluster>Generate the managed cluster</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export AWS_SSH_KEY_NAME<span style=color:#f92672>=</span>default
</span></span><span style=display:flex><span>export VPC_ADDON_VERSION<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;v1.10.2-eksbuild.1&#34;</span>
</span></span><span style=display:flex><span>clusterctl generate cluster manager --flavor eks-managedmachinepool-vpccni --kubernetes-version v1.20.2 --worker-machine-count<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> &gt; managed-cluster.yaml
</span></span></code></pre></div><p>In order for the cluster to be created in a different account we need to add the following to the <code>AWSManagedControlPlane</code> resource spec:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>identityRef</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AWSClusterRoleIdentity</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>managed-account</span>
</span></span></code></pre></div><p>And the following resources:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>envsubst &gt; cluster-role-identity.yaml <span style=color:#e6db74>&lt;&lt; EOL
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: AWSClusterRoleIdentity
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: managed-account
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  allowedNamespaces: {} # This is unsafe since every namespace is allowed to use the role identity
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  roleARN: arn:aws:iam::${AWS_MANAGED_ACCOUNT_ID}:role/controllers.cluster-api-provider-aws.sigs.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  sourceidentityRef:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    kind: AWSClusterControllerIdentity
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    name: default
</span></span></span><span style=display:flex><span><span style=color:#e6db74>---
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: AWSClusterControllerIdentity
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: default
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  allowedNamespaces:{}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOL</span>
</span></span></code></pre></div><h3 id=prepare-the-managed-account>Prepare the managed account</h3><p><strong>With the managed aws account credentials</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>envsubst &gt; bootstrap-managed-account.yaml <span style=color:#e6db74>&lt;&lt; EOL
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: bootstrap.aws.infrastructure.cluster.x-k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: AWSIAMConfiguration
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  eks:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    iamRoleCreation: false # Set to true if you plan to use the EKSEnableIAM feature flag to enable automatic creation of IAM roles
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    managedMachinePool:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      disable: true # Set to false to enable creation of the default node role for managed machine pools
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    fargate:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      disable: false # Set to false to enable creation of the default role for the fargate profiles
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  clusterAPIControllers:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    disabled: false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    trustStatements:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Action:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - &#34;sts:AssumeRole&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      Effect: &#34;Allow&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      Principal:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        AWS:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - &#34;arn:aws:iam::${AWS_MANAGER_ACCOUNT_ID}:role/controllers.cluster-api-provider-aws.sigs.k8s.io&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOL</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>clusterawsadm bootstrap iam create-cloudformation-stack --config bootstrap-managed-account.yaml
</span></span></code></pre></div><h3 id=deploy-the-managed-cluster>Deploy the managed cluster</h3><p><strong>Back to the manager account credentials</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl --kubeconfig manager.kubeconfig apply -f cluster-role-identity.yaml
</span></span><span style=display:flex><span>kubectl --kubeconfig manager.kubeconfig apply -f managed-cluster.yaml
</span></span></code></pre></div><p>Wait whatever time needed to provision the cluster and enjoy the multi-tenancy setup.</p></p></div><div class=page-footer><hr class=footer-divider><a class=tag href=/tags/aws>#AWS</a>
<a class=tag href=/tags/kubernetes>#Kubernetes</a>
<a class=tag href=/tags/cluster-api>#cluster-api</a>
<a class=tag href=/tags/k8s>#K8S</a></div><link rel=stylesheet type=text/css href=/css/katex.min.css crossorigin=anonymous><script type=text/javascript src=/js/katex.min.js crossorigin=anonymous></script>
<script type=text/javascript src=/js/auto-render.min.js onload=renderMathInElement(document.body) crossorigin=anonymous></script></div></div><footer class=footer-mobile><div class=social-icons><a class=social-icon href=mailto:luca+site@lanziani.com target=_blank rel=noopener title=Email><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M25.2794292 5.59128519 14 16.8707144 2.72057081 5.59128519C3.06733103 5.30237414 3.51336915 5.12857603 4 5.12857603H24c.4866308.0.932669000000001.173798110000001 1.2794292.46270916zM25.9956978 6.99633695C25.998551 7.04004843 26 7.08414302 26 7.12857603V20.871424C26 21.0798433 25.9681197 21.2808166 25.9089697 21.4697335l-7.1933342-7.1933342 7.2800623-7.28006235zM24.9498374 22.6319215C24.6672737 22.7846939 24.3437653 22.871424 24 22.871424H4C3.5268522 22.871424 3.09207889 22.7071233 2.74962118 22.432463l7.34540352-7.3454036 3.8897821 3.8897821L14.1878486 18.7737996l.0151933.0151933 3.4519334-3.4519335 7.2948621 7.2948621zM2.00810114 21.0526627C2.00273908 20.9929669 2 20.9325153 2 20.871424V7.12857603C2 7.08414302 2.00144896 7.04004843 2.00430222 6.99633695L9.03436454 14.0263993l-7.0262634 7.0262634z"/></svg></a><a class=social-icon href=https://twitter.com/lucalanziani target=_blank rel=noopener title=Twitter><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M8.991284 24.971612c10.189152.0 15.761088-8.441388 15.761088-15.761088C24.752372 8.970656 24.747512 8.731868 24.736496 8.494376 25.818008 7.712564 26.758256 6.737 27.5 5.62622c-.992628.440856-2.060748.738072-3.181248.871992 1.14372-.685584 2.02176-1.770768 2.435832-3.064176-1.070496.6345-2.25558 1.095984-3.517344 1.344492-1.010772-1.076652-2.450412-1.75014-4.043412-1.75014-3.059424.0-5.540292 2.480868-5.540292 5.539104.0.434808.0487079999999995.857412.14364 1.26306C9.19346 9.599108 5.11106 7.39472 2.3792 4.04294c-.476172.818424-.750168 1.769688-.750168 2.784132.0 1.921968.97794 3.61854 2.464992 4.61106C3.185528 11.41016 2.331788 11.160464 1.585184 10.745096 1.583888 10.768208 1.583888 10.791428 1.583888 10.815728c0 2.683152 1.909764 4.922856 4.4442 5.43078C5.562932 16.373084 5.07326 16.44134 4.56782 16.44134 4.210988 16.44134 3.863876 16.406024 3.526484 16.34144c.70524 2.200824 2.750112 3.802356 5.174928 3.8475-1.896264 1.485756-4.284576 2.37114-6.879924 2.37114C1.374476 22.56008.93362 22.534592.5 22.4834c2.451708 1.571076 5.362524 2.488212 8.491284 2.488212"/></svg></a><a class=social-icon href=https://www.linkedin.com/in/lucalanziani/ target=_blank rel=noopener title=LinkedIn><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M2 3.654102c0-.95502059.79442509-1.73012354 1.77383592-1.73012354H24.2261641C25.2058917 1.92397846 26 2.69908141 26 3.654102V24.3462148C26 25.3015521 25.2058917 26.0760215 24.2261641 26.0760215H3.77383592C2.79442509 26.0760215 2 25.3015521 2 24.3465315V3.65378524 3.654102zM9.27526132 22.1415901V11.2356668H5.65030092V22.1415901H9.27557808 9.27526132zM7.46341463 9.74691162c1.2638581.0 2.05068103-.83750395 2.05068103-1.88406715C9.49033893 6.79252455 8.72727273 5.97846056 7.48748812 5.97846056c-1.24073487.0-2.05099778.81406399-2.05099778 1.88438391.0 1.0465632.78650618 1.88406715 2.00316756 1.88406715h.02343998H7.46341463zM11.2815965 22.1415901h3.6246436v-6.089642C14.9062401 15.7263225 14.9299968 15.4000634 15.0256573 15.1675641c.261957499999999-.6515679.8584099-1.3259423 1.8599936-1.3259423 1.3113716.0 1.836237 1 1.836237 2.4662654v5.8337029h3.6246436V15.8885017c0-3.349699-1.7880899-4.9084574-4.172949-4.9084574-1.9553373.0-2.814064 1.0928097-3.2910991 1.8371872H14.9065569v-1.581248H11.2819132C11.3291099 12.2591067 11.2815965 22.1419069 11.2815965 22.1419069V22.1415901z"/></svg></a><a class=social-icon href=https://github.com/LucaLanziani target=_blank rel=noopener title=GitHub><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M13.9988029 1.32087331C6.82105037 1.32087331 1 7.14112562 1 14.3212723c0 5.7436386 3.72454649 10.6157955 8.89038951 12.3348169C10.5408085 26.7757983 10.7778323 26.374374 10.7778323 26.0296121 10.7778323 25.7215609 10.7666595 24.9035493 10.760275 23.8189856 7.14426471 24.6042767 6.38131925 22.0760223 6.38131925 22.0760223c-.59136253-1.5019491-1.44369072-1.9017772-1.44369072-1.9017772C3.75729765 19.3682044 5.02701126 19.3841656 5.02701126 19.3841656 6.33183953 19.4759425 7.01817121 20.7241085 7.01817121 20.7241085c1.15958133 1.9863716 3.04300319 1.4125664 3.78360289 1.0797753.1181129-.8395592.4540962-1.4125663.8251942-1.7373768C8.74038491 19.7385043 5.70536235 18.6228163 5.70536235 13.6413251c0-1.4189508.50676816-2.5801283 1.33834679-3.4883207C6.90963504 9.82420367 6.46351945 8.50181809 7.17139875 6.71256734c0 0 1.09094816-.34955032 3.57451115 1.33276037C11.78259 7.75642995 12.8950858 7.61277914 14.000399 7.60719272 15.1049142 7.61277914 16.2166119 7.75642995 17.2548881 8.04532771c2.4819669-1.68231069 3.571319-1.33276037 3.571319-1.33276037C21.5356825 8.50181809 21.0895669 9.82420367 20.9562909 10.1530044 21.7894656 11.0611968 22.2922435 12.2223743 22.2922435 13.6413251c0 4.9942601-3.039811 6.0931889-5.935173 6.4148071.4660671.401424200000001.8818564 1.194696.8818564 2.4077473C17.2389269 24.2012564 17.2229657 25.603448 17.2229657 26.0296121 17.2229657 26.3775663 17.4575954 26.7821827 18.116793 26.6552912 23.2786458 24.9322794 27 20.0633148 27 14.3212723 27 7.14112562 21.1789496 1.32087331 13.9988029 1.32087331"/></svg></a></div><div class=footer-mobile-links><p><a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy theme</a></p><span class=divider-bar>|</span><p><a href=https://gohugo.io target=_blank rel=noopener>Built with Hugo</a></p></div><script src=https://lanziani.com/js/main.min.a7205ef73b078c8daed6fe1b0826e8ba229ffabbb69d299d9446cf41f2c7d8aa.js integrity="sha256-pyBe9zsHjI2u1v4bCCbouiKf+ru2nSmdlEbPQfLH2Ko=" crossorigin=anonymous></script></footer></body></html>